<!DOCTYPE html>
<html>
<head>
    <title>Create New Password</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #eef1f7;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #new-password-form {
            width: 100%;
            max-width: 450px;
            padding: 35px 30px;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 10px 28px rgba(0,0,0,0.12);
        }

        h1 {
            text-align: center;
            color: #1e293b;
            margin-bottom: 25px;
            font-size: 28px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            color: #475569;
            font-weight: bold;
        }

        .input-wrapper {
            position: relative;
            width: 85%;
            margin: 0 auto 14px;
        }

        input {
            width: 100%;
            padding: 12px 16px;
            padding-right: 48px;
            border: 1px solid #cbd5e1;
            border-radius: 10px;
            font-size: 15px;
            box-sizing: border-box;
            transition: 0.2s;
            background: #fff;
            color: #0f172a;
            caret-color: #4f46e5;
        }

        input::placeholder {
            color: #94a3b8;
        }

        .eye-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 22px;
            height: 22px;
            opacity: 0.85;
            cursor: pointer;
            transition: 0.2s;
            padding: 4px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
            filter: brightness(1.1);
        }

        .eye-icon:hover {
            opacity: 1;
        }

        input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99,102,241,0.25);
            outline: none;
        }

        #np-btn {
            width: 100%;
            padding: 12px;
            background: #6366f1;
            border: none;
            color: white;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 10px;
        }

        #np-btn:hover {
            background: #4f46e5;
        }

        #np-msg {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }

        .btn-loading {
            position: relative;
            opacity: 0.8;
            pointer-events: none;
        }

        .btn-loading::after {
            content: "";
            position: absolute;
            right: 16px;
            top: 50%;
            width: 18px;
            height: 18px;
            border: 3px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            transform: translateY(-50%);
        }

        @keyframes spin {
            from { transform: translateY(-50%) rotate(0deg); }
            to { transform: translateY(-50%) rotate(360deg); }
        }

        .strength {
            font-size: 12px;
            margin-top: -5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

<form id="new-password-form">
    <h1>Create New Password</h1>

    <label>New Password</label>
    <div class="input-wrapper">
        <input type="password" id="new-pass" required>
        <img src="https://cdn-icons-png.flaticon.com/512/709/709612.png"
             id="toggle-new-pass"
             class="eye-icon">
    </div>
    <p id="strength-text" class="strength"></p>

    <label>Confirm Password</label>
    <div class="input-wrapper">
        <input type="password" id="confirm-pass" required>
        <img src="https://cdn-icons-png.flaticon.com/512/709/709612.png"
             id="toggle-confirm-pass"
             class="eye-icon">
    </div>

    <button type="submit" id="np-btn">Update Password</button>

    <p id="np-msg" style="color:red; display:none;"></p>
</form>

<script type="module">
import { API_BASE_URL } from '/config.js';

const newPassInput = document.getElementById('new-pass');
const confirmPassInput = document.getElementById('confirm-pass');
const npForm = document.getElementById('new-password-form');
const npBtn = document.getElementById('np-btn');
const msgEl = document.getElementById('np-msg');
const strengthText = document.getElementById('strength-text');

// Eye toggle
document.getElementById('toggle-new-pass').onclick = () => {
  newPassInput.type = newPassInput.type === 'password' ? 'text' : 'password';
};

document.getElementById('toggle-confirm-pass').onclick = () => {
  confirmPassInput.type = confirmPassInput.type === 'password' ? 'text' : 'password';
};

// Strength meter
newPassInput.addEventListener('input', () => {
  const pw = newPassInput.value;
  const isLong = pw.length >= 8;
  const hasUpper = /[A-Z]/.test(pw);
  const hasNumber = /\d/.test(pw);
  const hasSpecial = /[@$!%*?&#]/.test(pw);

  if (isLong && hasUpper && hasNumber && hasSpecial) {
    strengthText.textContent = 'Strong password âœ”';
    strengthText.style.color = 'green';
  } else {
    let msg = 'Password must include: ';
    if (!isLong) msg += '8 characters, ';
    if (!hasUpper) msg += '1 uppercase letter, ';
    if (!hasNumber) msg += '1 number, ';
    if (!hasSpecial) msg += '1 special character (@$!%*?&#), ';
    strengthText.textContent = msg.slice(0, -2);
    strengthText.style.color = 'red';
  }
});

// Submit handler
npForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const newPass = newPassInput.value.trim();
  const confirmPass = confirmPassInput.value.trim();

  msgEl.style.display = 'none';

  if (!newPass || !confirmPass) {
    msgEl.textContent = 'All fields are required.';
    msgEl.style.display = 'block';
    return;
  }

  if (newPass !== confirmPass) {
    msgEl.textContent = 'Passwords do not match.';
    msgEl.style.display = 'block';
    return;
  }

  const pendingUser = sessionStorage.getItem('pendingUser');
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');

  let body = {};

  if (pendingUser) {
    body = { username: pendingUser, new_password: newPass };
  } else if (token) {
    body = { token, new_password: newPass };
  } else {
    msgEl.textContent = 'Invalid or expired link.';
    msgEl.style.display = 'block';
    return;
  }

  npBtn.classList.add('btn-loading');

  try {
    const base = (API_BASE_URL || 'https://vtab-office-tool.onrender.com').replace(/\/$/, '');
    const res = await fetch(`${base}/api/reset-password`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });

    const data = await res.json();

    if (data.status === 'success') {
      alert('Password updated successfully!');
      sessionStorage.removeItem('pendingUser');
      window.location.href = 'login.html';
    } else {
      msgEl.textContent = data.message || 'Password update failed';
      msgEl.style.display = 'block';
    }
  } catch (err) {
    msgEl.textContent = 'Network error. Try again.';
    msgEl.style.display = 'block';
  } finally {
    npBtn.classList.remove('btn-loading');
  }
});
</script>

</body>
</html>
